<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Meu Carrinho</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/estilos-navegacao.css">
    <link rel="stylesheet" href="/css/estilos-carrinho.css">
</head>
<body>
<%- include('partials/nav-user') %>

<main>
    <h1>Meu Carrinho</h1>

    <% if (itens.length > 0) { %>
        <table class="tabela-carrinho">
            <thead>
            <tr>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Preço Unitário</th>
                <th>Total</th>
                <th>Ação</th>
            </tr>
            </thead>
            <tbody>
            <% let totalGeral = 0; %>
            <% itens.forEach(item => {
                const preco = Number(item.preco);
                const totalItem = preco * item.quantidade;
                totalGeral += totalItem;
            %>
            <tr>
                <td><%= item.nome %></td>
                <td>
                    <button onclick="alterarQuantidade(<%= item.id_item_carrinho %>, <%= item.quantidade - 1 %>)" <%= item.quantidade <= 1 ? 'disabled' : '' %>>-</button>
                    <span id="quantidade-<%= item.id_item_carrinho %>"><%= item.quantidade %></span>
                    <button onclick="alterarQuantidade(<%= item.id_item_carrinho %>, <%= item.quantidade + 1 %>)">+</button>
                </td>
                <td>R$ <%= preco.toFixed(2) %></td>
                <td id="total-item-<%= item.id_item_carrinho %>">R$ <%= totalItem.toFixed(2) %></td>
                <td>
                    <button onclick="removerItem(<%= item.id_item_carrinho %>)" class="botao-remover">Remover</button>
                </td>
            </tr>
            <% }) %>
            </tbody>
            <tfoot>
            <tr>
                <td colspan="4"><strong>Total Geral</strong></td>
                <td><strong id="subtotal">R$ <%= totalGeral.toFixed(2) %></strong></td>
            </tr>
            <tr>
                <td colspan="4">
                    <label for="frete-select"><strong>Escolher Frete:</strong></label>
                    <select id="frete-select" onchange="calcularTotalComFrete()">
                        <option value="">Selecione...</option>
                    </select>
                </td>
                <td id="frete-custo">R$ 0.00</td>
            </tr>
            <tr>
                <td colspan="4"><strong>Total com Frete</strong></td>
                <td><strong id="total-com-frete">R$ <%= totalGeral.toFixed(2) %></strong></td>
            </tr>
            </tfoot>
        </table>

        <div class="botoes-carrinho">
            <a href="/" class="botao-voltar">Continuar Comprando</a>
            <button class="botao-finalizar" onclick="finalizarCompra()">
                Finalizar Compra
            </button>
        </div>
    <% } else { %>
        <p>Seu carrinho está vazio.</p>
        <a href="/" class="botao-voltar">Voltar para a Loja</a>
    <% } %>
</main>

<script>
    // async function finalizarCompra() {
    //     try {
    //         const selectFrete = document.getElementById('frete-select');
    //         const id_frete = selectFrete.custo;
    //
    //         const resposta = await fetch('/clientes/api/pedidos/finalizar', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json',
    //                 body: JSON.stringify({ id_frete })
    //             },
    //         });
    //
    //         const resultado = await resposta.json();
    //
    //         if (resposta.status === 401) {
    //             window.location.href = '/clientes/login?redirect=/clientes/carrinho';
    //         } else if (resposta.ok) {
    //             alert('Pedido finalizado com sucesso!');
    //             window.location.href = '/clientes/pedidos';
    //         } else {
    //             alert('Erro ao finalizar pedido: ' + resultado.mensagem);
    //         }
    //     } catch (erro) {
    //         console.error('Erro:', erro);
    //         alert('Erro ao finalizar pedido.');
    //     }
    // }

    async function finalizarCompra() {
        const freteId = document.getElementById('frete-select').value; // Pega o id do frete selecionado

        if (!freteId) {
            alert("Por favor, selecione uma opção de frete.");
            return;
        }

        try {
            const resposta = await fetch('/clientes/api/pedidos/finalizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    frete_id: freteId
                })
            });

            const resultado = await resposta.json();

            if (resposta.status === 401) {
                window.location.href = '/clientes/login?redirect=/clientes/carrinho';
            } else if (resposta.ok) {
                alert('Pedido finalizado com sucesso!');
                window.location.href = '/clientes/pedidos';
            } else {
                alert('Erro ao finalizar pedido: ' + resultado.mensagem);
            }
        } catch (erro) {
            console.error('Erro:', erro);
            alert('Erro ao finalizar pedido.');
        }
    }
</script>


<% const carrinhoIdJS = Number(carrinho_id) || 0; %>
<script>
    const carrinhoId = <%- JSON.stringify(carrinhoIdJS) %>;
    let subtotal = <%= totalGeral.toFixed(2) %>;

    async function alterarQuantidade(itemId, novaQuantidade) {
        if (!carrinhoId) return alert('Carrinho não encontrado!');

        try {
            const resposta = await fetch(`/clientes/api/carrinhos/${carrinhoId}/itens/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantidade: novaQuantidade })
            });

            if (resposta.ok) {
                window.location.reload();
            } else {
                const erro = await resposta.json();
                alert('Erro ao atualizar: ' + erro.mensagem);
            }
        } catch (error) {
            alert('Erro na requisição');
        }
    }

    async function removerItem(itemId) {
        if (!carrinhoId) return alert('Carrinho não encontrado!');
        if (!confirm('Tem certeza que deseja remover este item?')) return;

        try {
            const resposta = await fetch(`/clientes/api/carrinhos/${carrinhoId}/itens/${itemId}`, {
                method: 'DELETE'
            });

            if (resposta.ok) {
                window.location.reload();
            } else {
                const erro = await resposta.json();
                alert('Erro ao remover: ' + erro.mensagem);
            }
        } catch (error) {
            alert('Erro na requisição');
        }
    }

    // async function carregarFretes() {
    //     try {
    //         const resposta = await fetch('/clientes/api/frete');
    //         const fretes = await resposta.json();
    //         const select = document.getElementById('frete-select');
    //
    //         fretes.forEach(frete => {
    //             const option = document.createElement('option');
    //             option.value = frete.id_frete; // usar o ID no value
    //             option.setAttribute('data-custo', frete.custo); // salva o custo como atributo extra
    //             option.textContent = `${frete.nome} - R$ ${frete.custo.toFixed(2)} (${frete.prazo_entrega} dias)`;
    //             select.appendChild(option);
    //         });
    //     } catch (error) {
    //         console.error('Erro ao carregar fretes:', error);
    //     }
    // }

    async function carregarOpcoesFrete() {
        const resposta = await fetch('/clientes/api/frete');
        const opcoes = await resposta.json();

        const select = document.getElementById('frete-select');
        select.innerHTML = '<option value="">Selecione...</option>'; // limpa e adiciona default

        opcoes.forEach(frete => {
            const option = document.createElement('option');
            option.value = frete.frete_id;
            option.textContent = `${frete.nome} - R$ ${frete.custo.toFixed(2)}`;
            option.setAttribute('data-valor', frete.custo);
            select.appendChild(option);
        });
    }

    // Exemplo de cálculo total com frete
    function calcularTotalComFrete() {
        const select = document.getElementById('frete-select');
        const valor = select.selectedOptions[0]?.getAttribute('data-valor') || 0;
        document.getElementById('frete-custo').textContent = `R$ ${parseFloat(valor).toFixed(2)}`;
    }

    window.onload = carregarOpcoesFrete;
</script>
</body>
</html>
